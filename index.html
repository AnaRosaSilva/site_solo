<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Laudo de Solo (JS)</title>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>
    <div class="container">
        <h1>üå± Relat√≥rio de Fertilidade do Solo</h1>

        <div id="secaoFormulario">
            <p class="description">Insira os resultados da sua an√°lise de solo para gerar as recomenda√ß√µes autom√°ticas.</p>
            
            <p id="erroMensagem" class="error"></p>

            <form id="laudoForm">
                <div class="input-grid">
                    <div class="input-group"><label for="inputpH">pH</label><input type="number" step="0.1" id="inputpH" required></div>
                    <div class="input-group"><label for="inputMO">Mat√©ria Org√¢nica (%)</label><input type="number" step="0.1" id="inputMO" required></div>
                    <div class="input-group"><label for="inputP">F√≥sforo (P em mg/dm¬≥)</label><input type="number" step="0.1" id="inputP" required></div>
                    <div class="input-group"><label for="inputK">Pot√°ssio (K em cmolc/dm¬≥)</label><input type="number" step="0.1" id="inputK" required></div>
                    <div class="input-group"><label for="inputCa">C√°lcio (Ca em cmolc/dm¬≥)</label><input type="number" step="0.1" id="inputCa" required></div>
                    <div class="input-group"><label for="inputMg">Magn√©sio (Mg em cmolc/dm¬≥)</label><input type="number" step="0.1" id="inputMg" required></div>
                    <div class="input-group"><label for="inputV">Satura√ß√£o por Bases (V%)</label><input type="number" step="0.1" id="inputV" required></div>
                    <div class="input-group"><label for="inputAl">Alum√≠nio (Al3+ em cmolc/dm¬≥)</label><input type="number" step="0.1" id="inputAl" required></div>
                </div>
                
                <button type="submit">Gerar Relat√≥rio</button>
            </form>
        </div>

        <div id="secaoRelatorio" style="display: none;">
            <h2>‚úÖ Laudo de Fertilidade do Solo Conclu√≠do</h2>

            <h3>Tabela de Resultados Detalhados</h3>
            
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Par√¢metro</th>
                        <th>Resultado</th>
                        <th>Refer√™ncia Ideal</th>
                        <th>Status e Recomenda√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="tabelaResultadosBody">
                    </tbody>
            </table>

            <div id="resumoGeral"></div> 

            <button id="downloadPdfButton" class="pdf-button">Baixar/Imprimir Laudo (PDF)</button>

            <button id="backButton" class="back-button">‚Üê Novo Laudo</button>
        </div>
    </div>
    
    <script>
        
        // ==============================================================================
        // 1. FUN√á√ïES DE REFER√äNCIA
        // ==============================================================================

        const obterReferencia = (parametro) => {
            const referencias = {
                "pH": "5.5 a 6.5",
                "Mat√©ria Org√¢nica (MO)": "> 3.0 %",
                "F√≥sforo (P)": "12 a 18 mg/dm¬≥",
                "Pot√°ssio (K)": "0.3 a 0.6 cmolc/dm¬≥",
                "C√°lcio (Ca)": "3.0 a 6.0 cmolc/dm¬≥",
                "Magn√©sio (Mg)": "1.0 a 2.0 cmolc/dm¬≥",
                "Satura√ß√£o por bases (V%)": "60 a 80 %",
                "Alum√≠nio (Al3+)": "< 0.3 cmolc/dm¬≥" 
            };
            return referencias[parametro] || "Refer√™ncia n√£o definida";
        };

        // ==============================================================================
        // 2. FUN√á√ïES DE AN√ÅLISE DOS PAR√ÇMETROS
        // ==============================================================================

        const analisarPh = (resultadoPh) => {
            if (resultadoPh < 5.5) {
                return "Baixo (√Åcido). Recomenda√ß√£o: Necess√°rio calagem para neutralizar a acidez.";
            } else if (resultadoPh > 6.5) {
                return "Alto. Recomenda√ß√£o: Pode causar indisponibilidade de micronutrientes.";
            }
            return "Ideal. Recomenda√ß√£o: Sem necessidade de corre√ß√£o de acidez.";
        };

        const analisarMo = (resultadoMo) => {
            if (resultadoMo < 3.0) {
                return "Abaixo do ideal. Recomenda√ß√£o: Adicionar mat√©ria org√¢nica (esterco, composto, palhada) para melhorar a estrutura e reten√ß√£o de √°gua.";
            }
            return "Ideal. Recomenda√ß√£o: Sem necessidade de corre√ß√£o.";
        };

        const analisarP = (resultadoP) => {
            if (resultadoP < 12) {
                return "Abaixo do ideal. Recomenda√ß√£o: Realizar aduba√ß√£o fosfatada, pois o P √© vital para o desenvolvimento radicular.";
            } else if (resultadoP > 18) {
                return "Acima do ideal. Recomenda√ß√£o: Reduzir ou suspender a aduba√ß√£o fosfatada.";
            }
            return "Ideal. Recomenda√ß√£o: Sem necessidade de corre√ß√£o.";
        };

        const analisarK = (resultadoK) => {
            if (resultadoK < 0.3) {
                return "Abaixo do ideal. Recomenda√ß√£o: Realizar aduba√ß√£o pot√°ssica (K √© essencial para a qualidade do fruto e resist√™ncia √† seca).";
            } else if (resultadoK > 0.6) {
                return "Acima do ideal. Recomenda√ß√£o: Suspender ou reduzir a aduba√ß√£o pot√°ssica.";
            }
            return "Ideal. Recomenda√ß√£o: Sem necessidade de corre√ß√£o.";
        };

        const analisarCa = (resultadoCa) => {
            if (resultadoCa < 3.0) {
                return "Abaixo do ideal. Recomenda√ß√£o: Aplicar calc√°rio calc√≠tico (rico em Ca) ou dolom√≠tico se o Mg tamb√©m estiver baixo.";
            } else if (resultadoCa > 6.0) {
                return "Acima do ideal. N√≠vel alto, mas aceit√°vel. Monitorar o equil√≠brio Ca:Mg:K.";
            }
            return "Ideal. Recomenda√ß√£o: Sem necessidade de corre√ß√£o.";
        };

        const analisarMg = (resultadoMg) => {
            if (resultadoMg < 1.0) {
                return "Abaixo do ideal. Recomenda√ß√£o: Aplicar calc√°rio dolom√≠tico (rico em Mg) para corrigir a defici√™ncia.";
            } else if (resultadoMg > 2.0) {
                return "Acima do ideal. Recomenda√ß√£o: N√≠vel alto. Aplicar calc√°rio calc√≠tico (puro Ca) para evitar excesso de Mg e manter o equil√≠brio.";
            }
            return "Ideal. Recomenda√ß√£o: Sem necessidade de corre√ß√£o.";
        };

        const analisarSaturacaoBases = (resultadoV) => {
            if (resultadoV < 60) {
                return "Baixa. Recomenda√ß√£o: Crucial para a produtividade. Aumentar a V% com calagem √© essencial.";
            } else if (resultadoV > 80) {
                return "Muito Alta. Recomenda√ß√£o: Monitorar.";
            }
            return "Ideal. Recomenda√ß√£o: Boa condi√ß√£o para a maioria das culturas.";
        };

        const analisarAluminio = (resultadoAl) => {
            if (resultadoAl >= 0.3) {
                return "Alto (T√≥xico). Recomenda√ß√£o: A calagem √© fundamental para a precipita√ß√£o do Alum√≠nio."; 
            }
            return "Baixo. Recomenda√ß√£o: N√≠vel seguro para as plantas.";
        };


        // ==============================================================================
        // 3. FUN√á√ÉO PRINCIPAL E L√ìGICA DE WEB
        // ==============================================================================

        const gerarRelatorioWeb = (event) => {
            event.preventDefault(); 
            
            const parametros = [
                { nome: 'pH', id: 'inputpH', analise: analisarPh, unidade: '' },
                { nome: 'Mat√©ria Org√¢nica (MO)', id: 'inputMO', analise: analisarMo, unidade: '%' },
                { nome: 'F√≥sforo (P)', id: 'inputP', analise: analisarP, unidade: 'mg/dm¬≥' },
                { nome: 'Pot√°ssio (K)', id: 'inputK', analise: analisarK, unidade: 'cmolc/dm¬≥' },
                { nome: 'C√°lcio (Ca)', id: 'inputCa', analise: analisarCa, unidade: 'cmolc/dm¬≥' },
                { nome: 'Magn√©sio (Mg)', id: 'inputMg', analise: analisarMg, unidade: 'cmolc/dm¬≥' },
                { nome: 'Satura√ß√£o por bases (V%)', id: 'inputV', analise: analisarSaturacaoBases, unidade: '%' },
                { nome: 'Alum√≠nio (Al3+)', id: 'inputAl', analise: analisarAluminio, unidade: 'cmolc/dm¬≥' }
            ];

            let resultadosHtml = "";
            const analisesResultados = {}; 

            try {
                parametros.forEach(p => {
                    const inputElement = document.getElementById(p.id);
                    if (!inputElement || inputElement.value === "") {
                        throw new Error("Por favor, preencha todos os campos.");
                    }
                    const resultado = parseFloat(inputElement.value);
                    
                    if (isNaN(resultado)) {
                        throw new Error("Por favor, insira apenas n√∫meros v√°lidos.");
                    }

                    const analiseTexto = p.analise(resultado);
                    analisesResultados[p.nome] = analiseTexto;

                    const referencia = obterReferencia(p.nome);
                    resultadosHtml += `
                        <tr>
                            <td>${p.nome}</td>
                            <td>${resultado} ${p.unidade}</td>
                            <td>${referencia}</td>
                            <td class="status">${analiseTexto}</td>
                        </tr>
                    `;
                });
                
                document.getElementById('tabelaResultadosBody').innerHTML = resultadosHtml;

                const resumoGeral = gerarResumoGeral(analisesResultados);
                document.getElementById('resumoGeral').innerHTML = resumoGeral;
                
                document.getElementById('secaoRelatorio').style.display = 'block';
                document.getElementById('secaoFormulario').style.display = 'none';
                document.getElementById('erroMensagem').textContent = '';

            } catch (error) {
                document.getElementById('erroMensagem').textContent = `Erro: ${error.message}`;
                document.getElementById('secaoRelatorio').style.display = 'none';
                document.getElementById('secaoFormulario').style.display = 'block';
            }
        };


        cconst gerarResumoGeral = (analisesResultados) => {
    // Usa os textos de an√°lise armazenados
    const analisePh = analisesResultados['pH'];
    const analiseV = analisesResultados['Satura√ß√£o por bases (V%)'];
    const analiseAl = analisesResultados['Alum√≠nio (Al3+)'];
    const analiseP = analisesResultados['F√≥sforo (P)'];
    const analiseK = analisesResultados['Pot√°ssio (K)'];
    const analiseCa = analisesResultados['C√°lcio (Ca)'];
    const analiseMg = analisesResultados['Magn√©sio (Mg)'];

    // Define as condi√ß√µes de corre√ß√£o
    const isCalagemPorPh = analisePh.includes("Necess√°rio calagem");
    const isCalagemPorV = analiseV.includes("Crucial");
    const isCalagemPorAl = analiseAl.includes("T√≥xico");

    const requerCalagem = isCalagemPorPh || isCalagemPorV || isCalagemPorAl;

    let resumoHtml = `<div class="resumo-box">
        <h3 class="resumo-title">RESUMO E RECOMENDA√á√ÉO DE MANEJO GERAL</h3>`;
    
    if (requerCalagem) {
        
        // --- NOVIDADE: MONTAGEM DO MOTIVO DA CALAGEM COM PRECIS√ÉO ---
        let motivos = [];
        if (isCalagemPorPh) motivos.push("Acidez Severa ($\text{pH}$ baixo)");
        if (isCalagemPorAl) motivos.push("Alum√≠nio T√≥xico ($\text{Al}^{3+}$)");
        if (isCalagemPorV) motivos.push("Baixa Satura√ß√£o por Bases ($\text{V\%}$) para o n√≠vel de produtividade desejado");
        
        const motivoCalagem = motivos.join(', e '); // Conecta os motivos (ex: "Acidez Severa, e Baixa Satura√ß√£o...")

        resumoHtml += `
            <p>üö® <strong>Prioridade M√°xima: CORRE√á√ÉO DO SOLO (CALAGEM)</strong>.</p>
            <p>Seu solo requer interven√ß√£o devido a ${motivoCalagem}.</p>
            <p>A calagem √© o primeiro passo para o sucesso da lavoura, visando aumentar o fornecimento de $\text{Ca}$ e $\text{Mg}$ e elevar a $\text{V\%}$.</p>
            <p><strong>Tipo de Calc√°rio Sugerido:</strong></p>
        `;
        
        if (deficienciaMg) {
             resumoHtml += `<p class="item-destaque">  -> <strong>Calc√°rio Dolom√≠tico:</strong> Necess√°rio corrigir a $\text{V\%}$ e a defici√™ncia de Magn√©sio (Mg=0.9 cmolc/dm¬≥ est√° abaixo do ideal 1.0)[cite: 358, 361].</p>`;
        } else if (deficienciaCa) {
             resumoHtml += `<p class="item-destaque">  -> <strong>Calc√°rio Calc√≠tico:</strong> Priorizar C√°lcio para corrigir a $\text{V\%}$, pois o Magn√©sio est√° adequado[cite: 372, 375].</p>`;
        } else {
             resumoHtml += `<p class="item-destaque">  -> <strong>Calc√°rio a Definir:</strong> (Consultar an√°lise de Mg/Ca) ou usar Dolom√≠tico para garantir o Mg.</p>`;
        }
        
        if (deficienciaP || deficienciaK) {
            resumoHtml += `<p><strong>Pr√≥ximo Passo:</strong> Ap√≥s o per√≠odo de rea√ß√£o do calc√°rio, ser√° necess√°ria a **Aduba√ß√£o de Corre√ß√£o** para repor os nutrientes $\text{P}$ e/ou $\text{K}$ deficientes.</p>`;
        }

    } else {
        // Se a acidez est√° controlada
        // A satura√ß√£o por bases (V%) deve estar adequada para cair neste bloco
        if (analiseV.includes("Ideal")) {
            resumoHtml += `<p>‚úÖ <strong>Status de Acidez:</strong> Seu solo est√° bem equilibrado ($\text{pH}$, $\text{V\%}$ e $\text{Al}^{3+}$ adequados).</p>`;
        } else {
            // Este caso s√≥ deve ocorrer se V% > 80, que √© Muito Alta
            resumoHtml += `<p>‚úÖ <strong>Status de Acidez:</strong> $\text{pH}$ e $\text{Al}^{3+}$ adequados. Monitorar $\text{V\%}$ (${analiseV.split('.')[0]}).</p>`;
        }
        
        const deficienciaCa = analiseCa.includes("Abaixo do ideal");
        const deficienciaMg = analiseMg.includes("Abaixo do ideal");
        const deficienciaP = analiseP.includes("Abaixo do ideal");
        const deficienciaK = analiseK.includes("Abaixo do ideal");
        
                if (deficienciaP || deficienciaK || deficienciaCa || deficienciaMg) {
                    resumoHtml += `<p>‚ö†Ô∏è <strong>Foco na Aduba√ß√£o de Corre√ß√£o:</strong> H√° defici√™ncias de nutrientes espec√≠ficos.</p>`;
                    
                    resumoHtml += `<p><strong>Recomenda√ß√µes Espec√≠ficas:</strong></p><ul>`;
                    if (deficienciaCa) resumoHtml += `<li>Aplicar <strong>C√°lcio (Ca)</strong>, provavelmente via gesso agr√≠cola (se o pH j√° estiver corrigido).</li>`;
                    if (deficienciaMg) resumoHtml += `<li>Aplicar <strong>Magn√©sio (Mg)</strong> (ex: sulfato de Mg).</li>`;
                    if (deficienciaP) resumoHtml += `<li>Realizar <strong>Aduba√ß√£o Fosfatada</strong> (P).</li>`;
                    if (deficienciaK) resumoHtml += `<li>Realizar <strong>Aduba√ß√£o Pot√°ssica</strong> (K).</li>`;
                    resumoHtml += `</ul>`;

                    // Reitera√ß√£o sobre P e MO (se estiverem acima/abaixo)
                    if (analiseP.includes("Acima do ideal")) {
                        resumoHtml += `<p>Nota: O F√≥sforo ($\text{P}$) est√° acima do ideal. Reduza a aduba√ß√£o fosfatada.</p>`;
                    }
                    if (analisesResultados['Mat√©ria Org√¢nica (MO)'].includes("Abaixo do ideal")) {
                        resumoHtml += `<p>Nota: A Mat√©ria Org√¢nica ($\text{MO}$) est√° abaixo do ideal. Mantenha ou intensifique a adi√ß√£o de composto/palhada[cite: 30].</p>`;
                    }
                
                } else {
                    resumoHtml += `<p>üéâ <strong>Parab√©ns!</strong> Seu solo est√° com excelente fertilidade. Continue com o manejo adequado e a <strong>Aduba√ß√£o de Manuten√ß√£o</strong> para a cultura que ser√° implantada.</p>`;
                }
            }
            
            resumoHtml += "</div>";
            return resumoHtml;
        };


        // ==============================================================================
        // 4. INICIALIZA√á√ÉO: Associa a fun√ß√£o ao clique do bot√£o
        // ==============================================================================

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('laudoForm');
            if (form) {
                form.addEventListener('submit', gerarRelatorioWeb);
            }
            
            const backButton = document.getElementById('backButton');
            if (backButton) {
                backButton.addEventListener('click', () => {
                    document.getElementById('secaoRelatorio').style.display = 'none';
                    document.getElementById('secaoFormulario').style.display = 'block';
                    document.getElementById('laudoForm').reset();
                    document.getElementById('erroMensagem').textContent = '';
                });
            }
            // Configura o bot√£o de Download/Imprimir PDF
            const downloadPdfButton = document.getElementById('downloadPdfButton');
            if (downloadPdfButton) {
                downloadPdfButton.addEventListener('click', () => {
                    // Este comando nativo abre a janela de impress√£o do navegador
                    window.print(); 
                    // O usu√°rio pode ent√£o escolher "Salvar como PDF"
                });
            }
        });
    </script>
</body>
</html>